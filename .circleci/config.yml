# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.
orbs:
  # Declare a dependency on the welcome-orb
  welcome: circleci/welcome-orb@0.4.1
# Orchestrate or schedule a set of jobs
workflows:
  # Name the workflow "welcome"
  welcome:
    # Run the welcome/run job in its own container
    jobs:
      build:
       machine: true
       steps:
        - checkout
        - run: docker run -d -p 80:80 --name nginx-sample-webapp $AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-1.amazonaws.com/nginx-sample-webapp:$CIRCLE_SHA1; sleep 10
    - run: curl --retry 10 --retry-delay 5 localhost:80 | grep "Hello World!"
    - run: docker build -t $AWS_ACCOUNT_ID.dkr.ecr.ap-northeast.amazonaws.com/nginx-sample-webapp:$CIRCLE_SHA1 .
